sessionStorage.clear(),console.log("Welcome to Chatsy! \uD83D\uDE80");import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";import{getFirestore as t,collection as n,addDoc as o,Timestamp as s}from"https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";import{authenticateUser as i}from"./passkey_chatsy.js";let socket=io("https://main-testing-server.onrender.com"),currentChat=null,chatHistory={},username,cu=new Set,uniqueCode,storage={},group={},token,masterKey,currentcc,groupss=new Set,locked=new Set,mygroups=new Set;setTimeout(()=>{loadChatHistory()},3e3);let thing=localStorage.getItem("grouptemphis");function addToChatHistory(e,t,n,o){chatHistory[e]||(chatHistory[e]=[]),encrypt(t,masterKey).then(t=>{chatHistory[e].push({text:t,timestamp:n,sent:o,uid:e}),saveChatHistory()})}thing&&(group=JSON.parse(thing));let isa=document.getElementById("is");function checkInternetConnection(){navigator.onLine||alert("No internet connection. Please check your network settings and try again.")}function checkProtocol(){window.location.href.startsWith("http://")&&kill()}function grc(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",t="";for(let n=0;n<30;n++){let o=Math.floor(Math.random()*e.length);t+=e.charAt(o)}return t}isa.onclick=()=>{var e,t;document.getElementById("chatMessages").lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})},setTimeout(()=>{f()},1e3),setInterval(checkInternetConnection,1e3),sessionStorage.setItem("men","f"),socket.on("report",e=>{e.name===uniqueCode&&notification("Someone reported you! You might be banned soon \uD83D\uDE2D.","error")}),checkProtocol(),setTimeout(()=>{sessionStorage.setItem("myname",username)},1e3);function validate(e){let t=localStorage.getItem("validation_state");if("await"===t){let n=grc();setTimeout(()=>{socket.emit("val",{val:e,id:n,uic:uniqueCode}),socket.on(n,e=>{"valid"!==e?kill():localStorage.setItem("validation_state","valid")})},1e3)}else{if("valid"===t)return;kill()}}function kill(){alert("Invalid user, redirecting to sign-in page"),localStorage.clear(),sessionStorage.clear(),firebase.auth().signOut().then(()=>{window.location.replace("https://chatsy2.web.app"),window.history.replaceState(null,null,window.location.href)})}document.getElementById("messageInput").addEventListener("keyup",function(e){"Enter"===e.key&&("chat"===currentcc?sendMessage(!0):"group"===currentcc?sendMessage(!1):sendMessage(!0))}),document.getElementById("us").addEventListener("keyup",function(e){if("Enter"===e.key){let t=document.getElementById("us").value;if(cu.has(t)){let n=sessionStorage.getItem(t);openChat(n)}else alert("No such user detected")}}),document.getElementById("sendButton").addEventListener("click",()=>{"chat"===currentcc?sendMessage(!0):"group"===currentcc?sendMessage(!1):sendMessage(!0)}),socket.on("disconnect",()=>{notification("You have been disconnected from the server. Please try reloading the page.","error","stay")});let url=window.location.href,newu=url.toString(),startIndex=newu.indexOf("?user="),endIndex=newu.indexOf("?uic="),endyindex=newu.indexOf("?valc="),userInfo=newu.substring(startIndex+6,endIndex),extractedString=newu.substring(endIndex+5,endyindex),valcode=newu.substring(newu.length-30);function f(){let e=grc();socket.emit("token",{uic:uniqueCode,code:e}),socket.on(e,e=>{token=e.token,localStorage.setItem("token_off",token)})}function removeUser(e,t){let n=document.getElementById("userList"),o=n.getElementsByClassName("user");for(let s=0;s<o.length;s++)if(o[s].textContent===e){o[s].remove();break}}validate(valcode),setInterval(()=>{validate(null)},1e3),socket.on("connect_error",e=>{console.error("Connection error:",e),alert("Unable to establish a connection with the server. Please check your network connection and try again later.")}),username=userInfo,setTimeout(()=>{sessionStorage.setItem("myuic",extractedString)},5e3),url.includes("uic=")||kill(),uniqueCode=extractedString,socket.on("connect",()=>{setInterval(()=>{socket.emit("id",{user:username,uic:uniqueCode})},100)}),socket.on("id",e=>{e.user!==username&&null===sessionStorage.getItem(e.uic)&&(sessionStorage.setItem(e.uic,e.user),sessionStorage.setItem(e.user+"id",e.uic))}),socket.on("disc",e=>{let t=sessionStorage.getItem(e.uic);sessionStorage.setItem(t+"id","disc"),setTimeout(()=>{removeUser(t,e.uic),sessionStorage.removeItem(e.uic),sessionStorage.removeItem(t+"id"),delete storage[e.uic],cu.delete(e.uic)},1e3)});let locky=document.getElementById("chatlock"),unlocky=document.getElementById("chatunlock");async function encrypt(e,t){try{let n=await CryptoJS.AES.encrypt(e,t).toString();return n}catch(o){notification(o,"error")}}async function decrypt(e,t){try{let n=await CryptoJS.AES.decrypt(e,t).toString(CryptoJS.enc.Utf8);return n}catch(o){notification(o,"error")}}function generateKeyForClientToClient(){let e="",t="0123456789ABCDEF";for(let n=0;n<64;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function notification(e,t,n){"error"===t?(document.getElementById("pop").textContent=e,document.getElementById("notification").style.color="#721c24",document.getElementById("cbb").style.color="#721c24",document.getElementById("notification").style.backgroundColor="#f8d7da",document.getElementById("notification").style.display="flex",null===n&&setTimeout(()=>{document.getElementById("notification").style.display="none"},7e3)):"notification"===t&&(document.getElementById("pop").textContent=e,document.getElementById("notification").style.color="#155724",document.getElementById("cbb").style.color="#155724",document.getElementById("notification").style.backgroundColor="#d4edda",document.getElementById("notification").style.display="flex",null===n&&setTimeout(()=>{document.getElementById("notification").style.display="none"},7e3))}locky.onclick=()=>{let e=grc();socket.emit("web-auth-status",{uid:uniqueCode,return:e}),socket.on(e,e=>{if("set"===e){let t=sessionStorage.getItem(currentChat+"id");locked.add(t),notification("Chat locked! (May take up to 5 seconds to authenticate and open chat)","notification")}else notification("Passkey not setup , please visit settings page to setup Passkey.","error")})},unlocky.onclick=()=>{let e=sessionStorage.getItem(currentChat+"id");locked.delete(e),notification("Chat unlocked!","notification")},setInterval(()=>{socket.emit("newuser",{uid:uniqueCode,name:username})},100),socket.on("newuser",e=>{if(e.uid!==uniqueCode&&!cu.has(e.uid)){let t=generateKeyForClientToClient();socket.emit("key",{to:e.uid,from:uniqueCode,key:t}),storage[e.uid]=t,cu.add(e.uid),addUser(e.name)}});let cgs=document.getElementById("cgc"),jgs=document.getElementById("jgc");function creategroup(e){if(null===e){document.getElementById("hover-menu").style.display="none";return}if(""===e){document.getElementById("hover-menu").style.display="none",alert("Group name cannot be empty");return}if(mygroups.has(e)){document.getElementById("hover-menu").style.display="none",alert("Group already exists");return}let t=DOMPurify.sanitize(e),n=grc();socket.emit("newgroup",{uic:uniqueCode,name:t,code:n}),socket.on(n,n=>{"error"!==n?(groupss.add(n.code),mygroups.add(e),alert(`Group ${t} has been created successfully! 🎉

Groups may experience minor issues temporarily, but rest assured they will be fully functional soon. Share the group code with others to join.

Please note: Groups are valid for this session only and will be deleted once all users have logged out.

Group Code: ${n.code}`),addUser(t,!0),sessionStorage.setItem(t+"group"+t,JSON.stringify({state:null,name:t,code:n.code,key:n.key,user_num:n.user_num})),document.getElementById("hover-menu").style.display="none",opengroup(e)):(document.getElementById("hover-menu").style.display="none",notification("Failed to create group.","error"))})}function joingroup(e){let t=DOMPurify.sanitize(e),n=grc();socket.emit("joingroup",{uic:uniqueCode,code:n,secret:t}),socket.on(n,e=>{if("error"===e)document.getElementById("hover-menu").style.display="none",alert("Error joining group.");else if("invalid"===e)document.getElementById("hover-menu").style.display="none",alert("Invalid code.");else if("valid"===e.state){if(mygroups.has(e.name)){document.getElementById("hover-menu").style.display="none",alert("You are already in this group.");return}groupss.add(t),addUser(e.name,!0),sessionStorage.setItem(e.name+"group"+e.name,JSON.stringify(e)),document.getElementById("hover-menu").style.display="none",alert("Joined group succesfully! Groups may experience minor issues temporarily, but rest assured they will be fully functional soon."),opengroup(e.name)}else"ex"===e&&(document.getElementById("hover-menu").style.display="none",alert("You are already in this group."))})}function addUser(e,t){let n=document.getElementById("userList"),o=document.createElement("div"),s=document.createElement("img");!0!==t?o.onclick=function(){openChat(e)}:o.onclick=function(){opengroup(e)},o.className="user",o.textContent=e,!0!==t?s.src="user.png":s.src="group.png",s.id="user--img",o.appendChild(s),n.appendChild(o)}function setBackgroundFromSessionStorage(){let e=localStorage.getItem("userImage");if(e){let t=document.getElementById("chatMessages");t.style.backgroundImage=`url(${e})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.style.backgroundRepeat="no-repeat"}}function handleSuccessfulAuthentication(e){var t=document.getElementById("stat/ccu");setInterval(()=>{t.scrollWidth>t.clientWidth||!t.scrollWidth?t.style.flexDirection="column":t.style.flexDirection="row"},100);let n=sessionStorage.getItem(e+"id");currentcc="chat",locked.has(n)?(document.getElementById("chatlock").style.display="none",document.getElementById("chatunlock").style.display="block"):(document.getElementById("chatunlock").style.display="none",document.getElementById("chatlock").style.display="block");let o=document.getElementById("messageInput");o.disabled=!1,setBackgroundFromSessionStorage(),sessionStorage.setItem("current",e),setInterval(()=>{"true"!==sessionStorage.getItem(e+"blocked")&&currentChat===e&&(document.getElementById("status").innerHTML="(Online)",document.getElementById("status").style.color="green",document.getElementById("status").style.fontWeight="800")},100),currentChat=e,document.getElementById("currentChatUser").innerHTML=e,setInterval(()=>{let t=sessionStorage.getItem(e+"id");("disc"===t||null===t)&&"true"!==sessionStorage.getItem(e+"blocked")&&currentChat===e&&(document.getElementById("status").innerHTML="(Offline)",document.getElementById("status").style.color="red",document.getElementById("status").style.fontWeight="800",o.disabled=!0,sessionStorage.removeItem(e))},100);let s=sessionStorage.getItem(e+"id"),i=chatHistory[s]||[],r=document.getElementById("chatMessages");r.innerHTML="",i.forEach(e=>{e.sent?decrypt(e.text,masterKey).then(t=>{displaySentMessage(t,e.timestamp)}):!1===e.sent&&decrypt(e.text,masterKey).then(t=>{displayReceivedMessage(t,e.timestamp,!0)})})}function onit(){var e=document.getElementById("ss");e.style.display="flex",e.style.flex="3",sessionStorage.setItem("men","t")}function offit(){document.getElementById("ss").style.display="none",sessionStorage.setItem("men","f")}function openChat(e){let t=sessionStorage.getItem("close-status");"true"===t&&offit();let n=sessionStorage.getItem(e+"id");if(locked.has(n)){let o=grc();socket.emit("web-auth-auth",{uid:uniqueCode,return:o}),socket.on(o,async t=>{i(t.ch,t.cid).then(t=>{200===t?handleSuccessfulAuthentication(e):400===t&&notification("Authentication failed!","error")}).catch(e=>{notification(e.message,"error"),console.error(e.message)})})}else{var s=document.getElementById("stat/ccu");setInterval(()=>{s.scrollWidth>s.clientWidth||!s.scrollWidth?s.style.flexDirection="column":s.style.flexDirection="row"},100),locked.has(n)?(document.getElementById("chatlock").style.display="none",document.getElementById("chatunlock").style.display="block"):(document.getElementById("chatunlock").style.display="none",document.getElementById("chatlock").style.display="block"),currentcc="chat";let r=document.getElementById("messageInput");r.disabled=!1,setBackgroundFromSessionStorage(),sessionStorage.setItem("current",e),setInterval(()=>{"true"!==sessionStorage.getItem(e+"blocked")&&currentChat===e&&(document.getElementById("status").innerHTML="(Online)",document.getElementById("status").style.color="green",document.getElementById("status").style.fontWeight="800")},100),currentChat=e,document.getElementById("currentChatUser").innerHTML=e,setInterval(()=>{let t=sessionStorage.getItem(e+"id");("disc"===t||null===t)&&"true"!==sessionStorage.getItem(e+"blocked")&&currentChat===e&&(document.getElementById("status").innerHTML="(Offline)",document.getElementById("status").style.color="red",document.getElementById("status").style.fontWeight="800",r.disabled=!0,sessionStorage.removeItem(e))},100);let l=sessionStorage.getItem(e+"id"),a=chatHistory[l]||[],c=document.getElementById("chatMessages");c.innerHTML="",c.innerHTML="",a.forEach(e=>{e.sent?decrypt(e.text,masterKey).then(t=>{displaySentMessage(t,e.timestamp)}):!1===e.sent&&decrypt(e.text,masterKey).then(t=>{displayReceivedMessage(t,e.timestamp,!0)})})}}function opengroup(e){let t=sessionStorage.getItem("close-status");"true"===t&&offit();var n=document.getElementById("stat/ccu");setInterval(()=>{n.scrollWidth>n.clientWidth?n.style.flexDirection="column":n.style.flexDirection="row"},100),document.getElementById("status").innerHTML="(Group)",document.getElementById("status").style.color="#373cbb",document.getElementById("status").style.fontWeight="800";let o=document.getElementById("chatMessages");o.innerHTML="",o.innerHTML="",setBackgroundFromSessionStorage();let s=JSON.parse(sessionStorage.getItem(e+"group"+e)),i=s.gcode;currentcc="group",currentChat=e+"group",document.getElementById("currentChatUser").innerHTML=e,sessionStorage.setItem("current",e);let r=document.getElementById("chatMessages"),l=document.createElement("div");l.className="message-container";let a=document.createElement("div");a.className="group_display",a.textContent="Group code: "+(i||s.code),l.appendChild(a),r.appendChild(l);let c=group[e+"group"+e]||[];c.forEach(e=>{e.sent?displaySentMessage(e.text,e.timestamp):!1===e.sent&&displayReceivedMessage(e.text,e.timestamp,!1)})}function sendMessage(e){if(!0===e){let t=document.getElementById("messageInput"),n=t.value;if(!currentChat){notification("No user selected.","error");return}let o=sessionStorage.getItem(currentChat+"id"),s=sessionStorage.getItem(o+"key");if(!s||!o){notification("User is offline.","error");return}if("true"===sessionStorage.getItem(currentChat+"blocked")){notification("You have blocked this user.","error");return}if(""!==n.trim()){let i=new Date().toLocaleTimeString(),r=`${n}`,l=displaySentMessage(r,i);encrypt(r,s).then(e=>{socket.emit("message",{message:e,time:i,to:o,from:uniqueCode,token:token}),t.value="",document.getElementById("chatMessages").lastElementChild.scrollIntoView({behavior:"smooth",block:"end"}),addToChatHistory(o,r,i,!0)}).catch(e=>{console.error(e),document.getElementById(l).style.background="red";let t=document.getElementById(l).textContent;document.getElementById(l).textContent=t+" ⚠️"})}}else if(!1===e){let a=document.getElementById("messageInput"),c=a.value,u=sessionStorage.getItem("current"),d=JSON.parse(sessionStorage.getItem(u+"group"+u)),m=d.key;if(""!==c.trim()){let g=new Date().toLocaleTimeString(),y=`You: ${c}`,p=`${c}`;displaySentMessage(y,g);let h=u+"group"+u;group[h]||(group[h]=[]),group[h].push({text:y,sent:!0,timestamp:g}),localStorage.setItem("grouptemphis",JSON.stringify(group)),encrypt(p,m).then(e=>{let t=d.code;socket.emit("groupmessage",{m:e,gcode:t,t:g,to:u,from:uniqueCode,name:username}),a.value="",document.getElementById("chatMessages").lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})})}}}function displaySentMessage(e,t){let n=grc(),o=document.getElementById("chatMessages"),s=document.createElement("div");s.className="message-container";let i=document.createElement("div"),r=document.createElement("div");if(r.id="xx",i.className="message-bubblei",i.id=n,i.textContent=e,i.onClick=function(){run()},s.appendChild(i),s.appendChild(r),t){let l=document.createElement("div");l.className="timestampi";let a=t.split(":"),c=parseInt(a[0],10),u=parseInt(a[1],10),d;d=u>10?`${c}:${u}`:`${c}:0${u}`,l.textContent=d,s.appendChild(l)}return o.appendChild(s),n}function displayReceivedMessage(e,t,n){let o=grc(),s=document.getElementById("chatMessages"),i=document.createElement("div");i.className="message-container";let r=document.createElement("div"),l=document.createElement("div");if(l.id="xx",r.className="message-bubble",r.id=o,r.textContent=e,!0===n?r.onclick=function(){mentry(e,o)}:r.onclick=function(){mentryg(e,o)},i.appendChild(r),i.appendChild(l),t){let a=document.createElement("div");a.className="timestamp";let c=t.split(":"),u=parseInt(c[0],10),d=parseInt(c[1],10),m;m=d>10?`${u}:${d}`:`${u}:0${d}`,a.textContent=m,i.appendChild(a)}s.appendChild(i)}cgs.onclick=()=>{document.getElementById("title").textContent="Create Group",document.getElementById("input-bar-input").placeholder="Group name...",document.getElementById("hover-menu"),document.getElementById("hover-menu").style.display="flex";let e=document.getElementById("input-bar-button");e.onclick=()=>{creategroup(document.getElementById("input-bar-input").value),document.getElementById("input-bar-input").value=""}},jgs.onclick=()=>{document.getElementById("title").textContent="Join Group",document.getElementById("input-bar-input").placeholder="Group code...",document.getElementById("hover-menu"),document.getElementById("hover-menu").style.display="flex";let e=document.getElementById("input-bar-button");e.onclick=()=>{joingroup(document.getElementById("input-bar-input").value),document.getElementById("input-bar-input").value=""}},socket.on((uniqueCode+"key").toString(),e=>{if(e.to===uniqueCode){let t=e.key;sessionStorage.setItem(e.from+"key",t)}}),socket.on(uniqueCode+"auth-disabled",e=>{let t=localStorage.getItem("token_off");e.token===t&&locked.clear()}),onit(),sessionStorage.setItem("close-status",!1),document.getElementById("user-prof").onclick=()=>{let e=sessionStorage.getItem(currentChat+"id"),t=grc();socket.emit("profile-req",{uid:e,return:t}),socket.on(t,t=>{document.getElementById("user-name").textContent=currentChat,document.getElementById("user-id").textContent=e,document.getElementById("user-int").textContent=t.int,document.getElementById("user-bio").textContent=t.bio,document.getElementById("user-email").textContent=t.email,document.getElementById("user-image").src=t.photo,document.getElementById("user-profile").style.display="flex"})},socket.on("group",e=>{if(e.from!==uniqueCode){let t=e.to;if(groupss.has(e.gcode)){let n=JSON.parse(sessionStorage.getItem(t+"group"+t)).key;opengroup(e.to),decrypt(e.m,n).then(n=>{var o,s;let i=t+"group"+t;group[i]||(group[i]=[]),group[i].push({text:e.name+": "+n,sent:!1,timestamp:e.t}),localStorage.setItem("grouptemphis",JSON.stringify(group)),displayReceivedMessage(e.name+": "+n,e.t),document.getElementById("chatMessages").lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})})}}}),socket.on("req-rejected"+uniqueCode,e=>{alert(e)}),socket.on((uniqueCode+"logout").toString(),e=>{e===uniqueCode&&(localStorage.clear(),sessionStorage.clear(),firebase.auth().signOut())}),socket.on((uniqueCode+"mess").toString(),e=>{let t=sessionStorage.getItem(e.from);if("true"!==sessionStorage.getItem(t+"blocked")&&e.to===uniqueCode){let n=storage[e.from];currentChat===t?decrypt(e.message,n).then(t=>{var n,o;addToChatHistory(e.from,t,e.time,!1),displayReceivedMessage(t,e.time,!0),document.getElementById("chatMessages").lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})}):(notification(`You have a new message from ${t} .`,"notification"),decrypt(e.message,n).then(t=>{addToChatHistory(e.from,t,e.time,!1)}))}});let auth=firebase.auth();function saveChatHistory(){let e=grc();socket.emit("save-req",{code:e,uid:uniqueCode,his:{x:JSON.stringify(chatHistory)}}),socket.on(e,e=>(1,void 0))}function loadChatHistory(){let e=grc();socket.emit("retrival-key",{uid:uniqueCode,token:token,code:e}),socket.on(e,e=>{masterKey=e});let t=grc();socket.emit("retrival",{uid:uniqueCode,token:token,code:t}),socket.on(t,e=>{let t=e;if(t){let n=t.x;chatHistory=JSON.parse(n)}})}auth.onAuthStateChanged(e=>{if(e){let t=e.uid;if(t!==uniqueCode)kill();else{let n=grc();socket.emit("session-key-create",{uid:t,return:n}),socket.on(n,e=>{localStorage.setItem("session-key",{key:e.key})})}}else window.location.replace("https://chatsy2.web.app"),window.history.replaceState(null,null,window.location.href)}),socket.on("notify",e=>{notification(e.message,e.type)});export{grc};
